---
title: "hw1"
author: "Liming Ning"
date: "2022/1/16"
geometry: margin=1in
output:
  html_document:
    code_folding: hide
    highlight: haddock
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float: yes
urlcolor: blue
always_allow_html: true
indent: true 
fontsize: 12pt
---

```{r setup, include=TRUE, cache=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F)
knitr::opts_knit$set(root.dir = 'G:/github/modern-data-mining/hw1/liming')
library(data.table)
library(reshape2)
library(readxl)
library(tidyverse)
library(cowplot)
library(kableExtra)
library(ggrepel)
library(skimr)
library(plotly)
```

```{r}
rm(list = ls())
```

# Case Study 1: Audience Size

Wharton Talk Show Business Radio Powered by the Wharton School received a generally positive reaction after being launched through the Sirius Radio station in January of 2014. This section aims at estimating the audience size for the show from the survey data via MTURK in May of 2014.

## Data Preparation
### Cleaning

In order to clean the data set, we firstly select and rename the variables Age, Gender, Education Level, Household Income in 2013, Sirius Listener?, Wharton
Listener? and Time.

```{r}
# selection
talkdata = fread("data/Survey_results_final.csv", encoding = "UTF-8")
talkdata.selected = 
  talkdata[,.(age = Answer.Age, # Note: some answers in Age are not numeric. Therefore, type of Answer.Age is character.
              gender = Answer.Gender, 
              education = Answer.Education, 
              income = Answer.HouseHoldIncome,
              sirius = `Answer.Sirius Radio`, 
              wharton = `Answer.Wharton Radio`, 
              worktime = WorkTimeInSeconds)]
```

*Note: Inconsistent rewards between instruction and data set.We found that the reward in the homework instruction is 0.1, but the reward variable in the data set is 0.05. We will use 0.05 in the following analysis.*
```{r}
talkdata$Reward[1:10] # question: 5 cents or 10 cents?
```

Then, we handling the missing or wrongly filled values of the selected variables.

**Age**
There are six suspicious observations in age. *Eighteen (18)* and *27`* are irregular but valid responses, so we transfer them into regular forms. We exclude the other four responses in the following analysis, as they are missing or irrelevant or unreasonable value. Then we transfer Age into numerical data.
```{r}
# detect suspicious observations
## age
talkdata.selected[!age %in% 10:100] # automatic type coercion when matching
talkdata.selected[age == "Eighteen (18)", age := "18"] # imputation
talkdata.selected[age == "27`", age := "27"] # imputation
talkdata.selected = talkdata.selected[age %in% 10:100] # delete NAs
talkdata.selected[,age := as.numeric(age)]
```


**Gender**
Six respondents ignored the question of gender.We exclude these responses considering that they cannot provide information and may mislead us in the following analysis regarding gender. Alternatively, if we do not exclude them, it hardly makes difference due to the large sample size.
```{r}
## gender
unique(talkdata.selected$gender)
talkdata.selected[!gender %in% c("Male","Female")]
talkdata.selected = talkdata.selected[gender != ""] # delete blanks
```


**Education**
It's plausible that the first five options in education cover all education levels. We exclude those responses of *Other* and *Select one*.
```{r}
## education
unique(talkdata.selected$education)
talkdata.selected = talkdata.selected[!education %in% c("Other","select one")] # delete because they are meaningless
```


**Income**
We exclude the responses with missing value in income.
```{r}
## income
unique(talkdata.selected$income)
talkdata.selected = talkdata.selected[income != ""] # delete blanks
```

**Sirius**
We exclude the responses with missing value in Sirius.
```{r}
## sirius
unique(talkdata.selected$sirius)
talkdata.selected = talkdata.selected[sirius != ""] # delete blanks
```
 
**Wharton**
We exclude the responses with missing value in Wharton. In addition, we exclude two unreasonable responses in which the answer for Sirius is No and the answer for Wharton is Yes.
```{r}
## wharton
unique(talkdata.selected$wharton)
talkdata.selected = talkdata.selected[wharton != ""] # delete blanks
talkdata.selected[sirius == "No" & wharton == "Yes"] # These two are weird. Delete
talkdata.selected = talkdata.selected[!(sirius == "No" & wharton == "Yes")]
```

```{r}
fwrite(talkdata.selected,"data/talkdata_cleaned.csv",row.names = F)
## worktime: automatically recorded.
# possible improvements: use skimr. get summary stats in one go and make imputation/dropping them.
# alternatives: do not delete some obs which seems to be valid expect for some missings/errors while we're not running a regression with the covariates
```

```{r}
rm(list = ls())
```

### Brief Summary
The data set was collected via MTURK in May of 2014, and the survey running for six days with a target maximum sample size of 2000. Respondents were limited to people in United States.
**Integer variables**
```{r}
# age and worktime, integer
talkdata.selected = fread("data/talkdata_cleaned.csv",encoding = "UTF-8")
age.stat = talkdata.selected %>% 
  summarise(mean = mean(age),min = min(age),median = median(age),max = max(age),"std. dev." = sd(age))
worktime.stat = talkdata.selected %>% 
  summarise(mean = mean(worktime),min = min(worktime),median = median(worktime),max = max(worktime), "std. dev." = sd(worktime))
cont.var.stat = rbind(age.stat,worktime.stat)
rownames(cont.var.stat) = c("age","worktime")
talkdata.size = nrow(talkdata.selected)
kbl(cont.var.stat, caption = "Summary Statistics for Non-categorical Variables", digits = 2, booktabs = T,
    align = "lccccc") %>%
  kable_styling(latex_options = c("HOLD_position"))%>%
   footnote(general = paste("The table reports the summary statistics for non-categorical variables in the talkshow data. The valid sample size is ",talkdata.size,".",sep = ""),
            threeparttable = T)

age.hist = ggplot(talkdata.selected,aes(x=age))+
  geom_histogram()+
  theme_bw()+
  labs(title = "Histogram for Ages")
worktime.hist = ggplot(talkdata.selected,aes(x=worktime))+
  geom_histogram()+
  theme_bw()+
  labs(title = "Histogram for Worktime")
plot_grid(age.hist,worktime.hist,nrow = 1) # right-skewed
```

The valid sample size is 1723. In regards to age and worktime, we summarize their characteristics through table and histograms. The data of age and worktime are both right-skewed. We can then conclude that most participants finished this survey in half a minute, and their age mostly distributed from 20 to 35. One potential reason may be that youngsters are more familiar with the Internet.

**Categorical variables**
```{r}
# categorical variables
## mapping
keywords.edu = data.table(education = unique(talkdata.selected$education))
keywords.edu[,order := c(3,5,4,2,1)]
keywords.edu = keywords.edu[order(order)]
for (i in 1:nrow(keywords.edu)) {
  talkdata.selected[education==keywords.edu$education[i],education:=keywords.edu$order[i]]
} # for education

keywords.income = data.table(income = unique(talkdata.selected$income))
keywords.income[,order := c(3,2,4,6,1,5)]
keywords.income = keywords.income[order(order)]
for (i in 1:nrow(keywords.income)) {
  talkdata.selected[income==keywords.income$income[i],income:=keywords.income$order[i]]
} # for income

## plots
get.bar = function(data,varname,x.label = varname,y.label = "count",...){

  ggplot(data,aes(x=eval(parse(text = varname))))+
    geom_bar(...)+
    xlab(x.label)+
    theme_bw()+
    labs(title = paste("Barplot of ",varname,sep = ""))
}

bar.list = list()
key.catevar = c("gender","education","income","sirius","wharton")
for (i in 1:length(key.catevar)) {
  bar.list[[i]] = get.bar(talkdata.selected,key.catevar[i])
}
plot_grid(plotlist = bar.list,nrow = 2)
```

We then make barplots to illustrate the characteristics of categorical variables gender, education, income, Sirius and Wharton. *Note: We map the education and income levels into integers for better exhibition. In regards to education, 1 represents "less than 12 years; no high school diploma", 2 represents "High school graduate (or equivalent)", 3 represents "Some college, no diploma; or Associate’s degree", 4 represents "Bachelor’s degree or other 4-year degree", 5 represents "Graduate or professional degree". In regards to income, 1 represents "Less than \$15,000", 2 represents "\$15,000 - \$30,000", 3 represents "\$30,000 - \$50,000", 4 represents "\$50,000 - \$75,000", 5 represents "\$75,000 - \$150,000", 6 represents "Above \$150,000".*

The key variables, Sirius and Wharton, are of our primary interest. Over two thirds of the respondents had ever listened to Sirius Radio, indicating that the distribution of the survey was not inefficient, and our concern is the data of Wharton providing a "Yes" in Sirius. 

As for the covariates, it is revealed that the number of male respondents was significantly larger than that of female respondents. Education levels were generally not high, as few of them had a degree higher than bachelor. Income levels of the respondents were concentrated on the interval of \$15,000 - \$75,000 in 2014, and a considerable proportion of respondents earned less than \$15,000 per year. Self-selection bias is implicated to exist in the data set, because only people working at MTurk are exposed to this survey. People with low income and low education level may have less opportunity cost for becoming a surveyor, so the sample may tilt towards them. Since income and education are plausibly correlated with the exposure to wharton business radio programs, the final estimate can be biased.

## Sample Properties
```{r}
# what's the dist? to be found
# multivariate t-stats
```

## Final Estimates

Assuming that the sample is a random sample of the MTURK population, and that the proportion of Wharton listeners vs. Sirius listeners in the general population is the same as that in the MTURK population, we then come to our conclusion of Wharton audience size.

```{r}
p = sum(talkdata.selected$wharton=="Yes")/sum(talkdata.selected$sirius=="Yes")
number = 51.6*p
sigma = sqrt(p*(1-p)/sum(talkdata.selected$sirius=="Yes")) # use clt
paste("Point estimate for p:", paste0(round(p, digits = 3)*100,"%."))
paste("95% CI for p: [",paste0(round(p-1.96*sigma,digits = 3)*100,"%"),", ",paste0(round(p+1.96*sigma,digits = 3)*100,"%"),"].",sep = "")
paste("Point estimate for the number of wharton radio audience:", paste0(round(number, digits = 3)," million."))
paste("95% CI for the number of wharton radio audience: [",paste0(round((p-1.96*sigma)*51.6,digits = 3)," million"),", ",paste0(round((p+1.96*sigma)*51.6,digits = 3)," million"),"].",sep = "")
```

executive sunmmary TBD

## New Task
```{r}
# why not contact Sirius for data?
```

The key issue is to access the population in Sirius and get to know if they have ever listened to Wharton radio program. The best approach in theory is trying to get the administrative data of Sirius, which allows us to observe audience flow directly. This is unrealistic with only \$1,000 except we have some special relationship with the company. 

A second choice is to do surveys targeted at the population in Sirius. Disseminating surveys on Sirius platform (in a form of advertisement in some corners) or sending invitation emails to Sirius users can be useful, but they are also not practical. For the former, we face the budget constraint; for the latter, we have no access to users' mail addresses. Therefore, we have to rely on third-party platforms. We decide to stick to MTurk. We employ the same structure as the original survey, but modify a bit to enhance the reliability. 

**Goal** Estimate the audience size of Wharton Business Radio Show

**Method** We choose to launch a survey through Amazon Mechanical Turk. We want to estimate the proportion of Wharton Business Radio listeners to the people who use SiriusXM, p, then we multiply p with the total number of users of SiriusXM.

**Details of The Survey** We restrict the surveyors' location to be within US. In the Survey, we will ask about their gender, age, education, income level as usual, in addition to out key questions “Have you ever used SiriusXM? Have you listened to the Wharton Business Radio Show?”. To avoid casual answers by respondents, we will add other questions in the questionnaire as attention tests, such as: *What do you think of the competence of Joe Biden as the president? Please choose "Don't know" directly.  Answer: Extremely good, Good, Normal, Bad, Extremely bad, Don't know.* The survey lasts about two weeks on Amazon Mechanical Turk. 

**Cost Estimate**  Reward per Assignment*total number of assignments + estimated fees to Mechanical Turk

Here we choose a reward of \$0.05 per assignment, and we want about 3000 workers in Mechanical Turk to answer our survey. Based on the Mechanical Turk payment rule, we need to pay about \$60 to Amazon Mechanical Turk. Thus, the cost is about \$210. 


```{r}
rm(list = ls())
```

# Case Study 2: Women in Science

This section aims at answer several questions about women in science. The data set is assembled from NSF about various degrees granted in the U.S. from 2006 to 2016. The questions are listed below:

**Are women underrepresented in science in general?**

**How does gender relate to the type of educational degree pursued?**

**Does the number of higher degrees increase over the years?**

## Data Preparation
**Data cleaning**

Fistly, we import the spreadsheat and clean the data.

```{r,include=F}
degreedata = read_excel("Data/WomenData_06_16.xlsx")
degreedata = data.table(degreedata)
setnames(degreedata,1:5,c("field","degree","sex","year","number"))

which(rowSums(is.na(degreedata))==1) # no NA
```
There is no missing value in the data set. It is well cleaned beforehand.

**Unique fields**
```{r}
# cleaning & summary
unique(degreedata$field)
```
There are ten different fields in the data, where sci-related fields are further divided while non-sci fields are integrated. 

**Unique degrees**
```{r}
unique(degreedata$degree)
```
Three types of degrees are included: bachelor (BS), master (MS) and Doctor of Philosophy (PhD).

**Unique sex**
```{r}
unique(degreedata$sex) # no a third sex
```
We check in addition if there are a third sex besides male and female which is reported. The answer is no.

**Unique years**
```{r}
unique(degreedata$year) # conform to the data description
```

11 years, 2006-2016, are included in the data set. It is consistent with the data description.


```{r, eval=F}
summary(degreedata$number)
ggplot(degreedata,aes(x=number))+
  geom_histogram()+
  theme_bw()+
  labs(title = "Histogram of Granted Degree Number, Pool of All Years") # outliers
# skim(degreedata)
```


## BS degrees in 2015
```{r}
degreedata[,sci := field != "Non-S&E"]

degreedata.bs.2015 = degreedata[degree == "BS" & year == 2015]
summary.bs.2015 = 
  degreedata.bs.2015[,.(number = sum(number)),by = .(sex,sci)]
summary.bs.2015[, percent := number/sum(number),by = sci]
summary.bs.2015.wide = data.frame(acast(summary.bs.2015,sci~sex,value.var = "number"))
rownames(summary.bs.2015.wide) = c("Non-sci","Sci")
summary.bs.2015.wide = mutate(summary.bs.2015.wide,Female.per = 
                                paste(sprintf('%0.1f',round(summary.bs.2015$percent[c(2,1)]*100,digits = 1)),"%",sep = ""))

# summary table
kbl(summary.bs.2015.wide, caption = "Summary Statistics for BS Degrees Granted in 2015 by Sex", digits = 2, booktabs = T,align = "lccc") %>%
  kable_styling(latex_options = c("HOLD_position"))%>%
   footnote(general = "The table reports the summary statistics for the amount of BS degrees granted in 2015 by sex in the US degree data.",
            threeparttable = T)

# bar plot
ggplot(summary.bs.2015,aes(x=sci,weight=number,fill=sex))+
  geom_bar(color = "black", width = .7,position = 'dodge')+
  theme_classic()+
  ylab('Number')+
  xlab('Sci field')+
  scale_fill_brewer(palette = "Set1")+
  labs(title = "The Barplot of BS Degrees Granted in 2015, by Sex")
```

In 2015, the number of BS degrees in SCI fields granted to males is approximately the same as that of females, while males received far fewer BS degrees in non-sci fields than females. From the summary statistics and the bar chart of BS degrees in 2015, we can see the preliminary evidence of the underrepresentation for females in sci fields relative to non-sci fields. However, given the balanced distribution in gender in the population, the statement that males are undderrepresented in non-sci field seems to be more acceptable, in an absolute sense.

## Bring in Type of Degree, 2015
```{r}
summary.2015.sex.degree = degreedata[year==2015,
                          .(number = sum(number)),
                          by = .(sex,degree)]

# table
summary.2015.sex.degree.wide = data.frame(acast(summary.2015.sex.degree,degree~sex))
summary.2015.sex.degree.wide = mutate(summary.2015.sex.degree.wide,
                                      Female.per = paste(sprintf('%0.1f',round(Female/(Female+Male)*100,digits = 1)),"%",sep = ""))
kbl(summary.2015.sex.degree.wide, caption = "Summary Statistics for Degrees Granted in 2015 by Sex", digits = 2, booktabs = T,align = "lccc") %>%
  kable_styling(latex_options = c("HOLD_position"))%>%
   footnote(general = "The table reports the summary statistics for the amount of degrees granted in 2015 by sex in the US degree data.",
            threeparttable = T)

# barplot
ggplot(summary.2015.sex.degree,aes(x=degree,weight=number,fill=sex))+
  geom_bar(color = "black", width = .7,position = 'dodge')+
  theme_classic()+
  ylab('Number')+
  xlab('Degree')+
  scale_fill_brewer(palette = "Set1")+
  labs(title = "The Barplot of Degrees Granted in 2015, by Sex")
```

The percentage of females granted bachelor and master degrees is close to 60\%, while that for PhD degrees are just 50\%, aggregating the number in all fields. It is plausible that the proportion of females decreases as the education level gets higher. Since people having a PhD degree generally also have a bachelor degree, a reasonable interpretation of the pattern is that given two undergrads who only differ in genders, the male may be more likely to further pursue the PhD degree after graduation.

## Bring All Variables
```{r}
summary.sex.time = degreedata[,
                          .(number = sum(number)),
                          by = .(sex,year)]
summary.sex.time[,percent := number/sum(number),by = year]

# table
summary.sex.time.wide = data.frame(acast(summary.sex.time,year~sex,value.var = "number"))
summary.sex.time.wide = mutate(summary.sex.time.wide,
                                      Female.per = paste(sprintf('%0.1f',round(Female/(Female+Male)*100,digits = 1)),"%",sep = ""))
kbl(summary.sex.time.wide, caption = "Summary Statistics for Degrees Granted by Sex, 2006-2016", digits = 2, booktabs = T,align = "lccc") %>%
  kable_styling(latex_options = c("HOLD_position"))%>%
   footnote(general = "The table reports the summary statistics for the amount of all degrees granted within 2006-2016 by sex in the US degree data.",
            threeparttable = T)

# barplot
ggplot()+
  geom_bar(data = summary.sex.time,aes(x=as.factor(year),weight=number,fill=sex),
           color = "black", width = .7,position = 'dodge')+
  theme_classic()+
  ylab('Number')+
  scale_y_continuous(limits = c(0,2000000),
                     sec.axis = sec_axis(~./10000000+0.4, name = "Female Percent"))+
  geom_line(data = summary.sex.time[sex=="Female"],
            aes(x=as.factor(year),y=10000000*(percent-0.4),group=1))+
  xlab('Year')+
  scale_fill_brewer(palette = "Set1")+
  labs(title = "The Barplot of Degrees Granted in 2006-2016, by Sex")
```

The proportion of females granted degrees over 2006-2016 is relatively stable, aggregating all degrees. The number of degrees granted to both genders increase over time, but there is little evidence of time effects on the relative number of degrees granted to two genders. 

```{r}
# aggregate fields
agg.field = degreedata[,.(
  number = sum(number)
),by = .(degree,sex,year,sci)]
```

```{r, eval=FALSE}
# p = ggplot(data = degreedata, aes(x=degree, weight = number, fill=sex, frame = year)) +
#    geom_bar(color = "black", width = .7,position = 'dodge')+
#   theme_classic()+
#   ylab('Number')+
#   xlab('Degree')+
#   scale_fill_brewer(palette = "Set1")+
#   theme_bw()
# 
# ggplotly(p) # problem: cannot use frame in barplots???

# p = ggplot(data = agg.field, aes(x=degree, y = number, group = sex, color = sex,
#                                   frame = year)) +
#    geom_line(size = 1)+
#   theme_classic()+
#   ylab('Number')+
#   xlab('Degree')+
#   theme_bw()
# 
# ggplotly(p) 
```

```{r}
# make more plots
# bs
plot.sci.bs = ggplot(data = agg.field[sci==T&degree=="BS"],aes(x=as.factor(year),weight = number,
                                                               fill=sex)) +
  geom_bar(color = "black", width = .7, position = "dodge") + 
  labs(title = "SCI Degree, BS")+
  ylab("Number")+
  xlab("Degree")+
  scale_fill_brewer(palette = "Set1")+
  theme_bw()

plot.nonsci.bs = ggplot(data = agg.field[sci==F&degree=="BS"],aes(x=as.factor(year),weight = number,
                                                               fill=sex)) +
  geom_bar(color = "black", width = .7, position = "dodge") + 
  labs(title = "Non-SCI Degree, BS")+
  ylab("Number")+
  xlab("Degree")+
  scale_fill_brewer(palette = "Set1")+
  theme_bw()
#ms
plot.sci.ms = ggplot(data = agg.field[sci==T&degree=="MS"],aes(x=as.factor(year),weight = number,
                                                               fill=sex)) +
  geom_bar(color = "black", width = .7, position = "dodge") + 
  labs(title = "SCI Degree, MS")+
  ylab("Number")+
  xlab("Degree")+
  scale_fill_brewer(palette = "Set1")+
  theme_bw()

plot.nonsci.ms = ggplot(data = agg.field[sci==F&degree=="MS"],aes(x=as.factor(year),weight = number,
                                                               fill=sex)) +
  geom_bar(color = "black", width = .7, position = "dodge") + 
  labs(title = "Non-SCI Degree, MS")+
  ylab("Number")+
  xlab("Degree")+
  scale_fill_brewer(palette = "Set1")+
  theme_bw()
#phd
plot.sci.phd = ggplot(data = agg.field[sci==T&degree=="PhD"],aes(x=as.factor(year),weight = number,
                                                               fill=sex)) +
  geom_bar(color = "black", width = .7, position = "dodge") + 
  labs(title = "SCI Degree, PhD")+
  ylab("Number")+
  xlab("Degree")+
  scale_fill_brewer(palette = "Set1")+
  theme_bw()

plot.nonsci.phd = ggplot(data = agg.field[sci==F&degree=="PhD"],aes(x=as.factor(year),weight = number,
                                                               fill=sex)) +
  geom_bar(color = "black", width = .7, position = "dodge") + 
  labs(title = "Non-SCI Degree, PhD")+
  ylab("Number")+
  xlab("Degree")+
  scale_fill_brewer(palette = "Set1")+
  theme_bw()

grid.sci = plot_grid(plot.sci.bs,plot.nonsci.bs,plot.sci.ms,plot.nonsci.ms,plot.sci.phd,plot.nonsci.phd,labels = "AUTO",nrow = 3)
ggsave(grid.sci,filename = "graphs/grid_scivsnonsci.png",width = 12,height = 18)
```
![](G:/github/modern-data-mining/hw1/liming/graphs/grid_scivsnonsci.png)
From panel A, C and E, males were granted more degrees in SCI fields; with the increase in education level, the difference between number of degrees granted to two genders enlarges, and it is consistent overtime. From panel B, D and F, females were granted more degrees in non-SCI fields; there is no clear evidence of increase in number of degrees granted to males relative to females, with the ascendance of education level. The proportion of females in MS degree is even larger than that in the bachelor degree. 

The number of all degrees granted have a increasing trend in 2006-2016, but one interesting observation is that a stagnation in PhD degree granted in 2007-2010 emerged in both SCI and non-SCI field. There was even a sharp drop in 2010 in non-SCI field. 

## Focus on Data Science 
```{r}
degreedata[, datasci := field %in% c("Computer sciences","Mathematics and statistics")]
summary.ds = degreedata[,
                             .(number = sum(number)),
                             by = .(sci,datasci,sex,year)]
summary.ds.timeagg = summary.ds[,.(number = sum(number)),by = .(sci,datasci,sex)]
summary.ds.timeagg[, percent := number/sum(number),by = .(datasci,sci)]

# sci vs non-sci: we have conclusions before. We want to know whether it's more severe in ds compared to other sci.
summary.ds.timeagg.wide = data.frame(acast(summary.ds.timeagg[sci==T],datasci~sex,value.var = "number"))
rownames(summary.ds.timeagg.wide) = c("non-data sci"," data sci")
summary.ds.timeagg.wide = mutate(summary.ds.timeagg.wide,Female.per = 
                                paste(sprintf('%0.1f',round(summary.ds.timeagg$percent[1:2]*100,digits = 1)),"%",sep = ""))

# summary table
kbl(summary.ds.timeagg.wide, caption = "Summary Statistics for Degrees Granted in SCI Field by Sex", digits = 2, booktabs = T,align = "lccc") %>%
  kable_styling(latex_options = c("HOLD_position"))%>%
   footnote(general = "The table reports the summary statistics for the amount of sci degrees granted over the sample period, separated by sex and data science or not.",
            threeparttable = T)

# barplot
ggplot(summary.ds.timeagg[sci==T],aes(x=datasci,weight=number,fill=sex))+
  geom_bar(color = "black", width = .7,position = 'dodge')+
  theme_classic()+
  ylab('Number')+
  xlab('data science')+
  scale_fill_brewer(palette = "Set1")+
  labs(title = "The Barplot of Degrees Granted in SCI Field, by Sex")
```

Since we have explored the comparison between SCI and non-SCI field, here we focus on the comparison between data science field and  non-data science field within SCI field. It can be seen from the summary statistics table and the bar chart aggregated all degrees and all years that the proportion of females granted degrees in data science field is significantly smaller than that in other SCI field. An absolute value of only 27.1\% indicates a severe undderrepresentation for females in data science. 

```{r}
# aggregate fields
agg.field.scionly = degreedata[sci==T,.(
  number = sum(number)
),by = .(degree,sex,year,datasci)]

# make more plots
# bs
plot.datasci.bs = ggplot(data = agg.field.scionly[datasci==T&degree=="BS"],aes(x=as.factor(year),weight = number,
                                                               fill=sex)) +
  geom_bar(color = "black", width = .7, position = "dodge") + 
  labs(title = "Data SCI Degree, BS")+
  ylab("Number")+
  xlab("Degree")+
  scale_fill_brewer(palette = "Set1")+
  theme_bw()

plot.nondatasci.bs = ggplot(data = agg.field.scionly[datasci==F&degree=="BS"],aes(x=as.factor(year),weight = number,
                                                               fill=sex)) +
  geom_bar(color = "black", width = .7, position = "dodge") + 
  labs(title = "Non-data SCI Degree, BS")+
  ylab("Number")+
  xlab("Degree")+
  scale_fill_brewer(palette = "Set1")+
  theme_bw()
#ms
plot.datasci.ms = ggplot(data = agg.field.scionly[datasci==T&degree=="MS"],aes(x=as.factor(year),weight = number,
                                                               fill=sex)) +
  geom_bar(color = "black", width = .7, position = "dodge") + 
  labs(title = "Data SCI Degree, MS")+
  ylab("Number")+
  xlab("Degree")+
  scale_fill_brewer(palette = "Set1")+
  theme_bw()

plot.nondatasci.ms = ggplot(data = agg.field.scionly[datasci==F&degree=="MS"],aes(x=as.factor(year),weight = number,
                                                               fill=sex)) +
  geom_bar(color = "black", width = .7, position = "dodge") + 
  labs(title = "Non-data SCI Degree, MS")+
  ylab("Number")+
  xlab("Degree")+
  scale_fill_brewer(palette = "Set1")+
  theme_bw()
#phd
plot.datasci.phd = ggplot(data = agg.field.scionly[datasci==T&degree=="PhD"],aes(x=as.factor(year),weight = number,
                                                               fill=sex)) +
  geom_bar(color = "black", width = .7, position = "dodge") + 
  labs(title = "Data SCI Degree, PhD")+
  ylab("Number")+
  xlab("Degree")+
  scale_fill_brewer(palette = "Set1")+
  theme_bw()

plot.nondatasci.phd = ggplot(data = agg.field.scionly[datasci==F&degree=="PhD"],aes(x=as.factor(year),weight = number,
                                                               fill=sex)) +
  geom_bar(color = "black", width = .7, position = "dodge") + 
  labs(title = "Non-data SCI Degree, PhD")+
  ylab("Number")+
  xlab("Degree")+
  scale_fill_brewer(palette = "Set1")+
  theme_bw()

grid.datasci = plot_grid(plot.datasci.bs,plot.nondatasci.bs,plot.datasci.ms,plot.nondatasci.ms,plot.datasci.phd,plot.nondatasci.phd,labels = "AUTO",nrow = 3)
ggsave(grid.datasci,filename = "graphs/grid_datascivsnondatasci.png",width = 12,height = 18)
```
![](G:/github/modern-data-mining/hw1/liming/graphs/grid_datascivsnondatasci.png)
Males were granted more degrees in SCI fields, no matter in data science or non-data science. With the increase in education level, the difference between number of degrees granted to two genders enlarges in non-data science field, and it is consistent overtime. however, in data science field, there is no clear evidence of increase in number of degrees granted to males relative to females, with the ascendance of education level, possibly because that the proportion of males is high enough initially. One observation is that the proportion of females in MS degree is even larger than that in the bachelor and PhD degree in data science field.

```{r, eval=F}
### By Degree
## 
summary.ds.bs = degreedata[sci==TRUE&degree=="BS",.(
  number = sum(number)
), by = .(datasci,sex)]
summary.ds.bs[, percent := number/sum(number),by = .(datasci)]
summary.ds.ms = degreedata[sci==TRUE&degree=="MS",.(
  number = sum(number)
), by = .(datasci,sex)]
summary.ds.ms[, percent := number/sum(number),by = .(datasci)]
summary.ds.phd = degreedata[sci==TRUE&degree=="PhD",.(
  number = sum(number)
), by = .(datasci,sex)]
summary.ds.phd[, percent := number/sum(number),by = .(datasci)]

# sci vs non-sci: we have conclusions before. We want to know whether it's more severe in ds compared to other sci.
summary.ds.bs.wide = data.frame(acast(summary.ds.bs,datasci~sex,value.var = "number"))
rownames(summary.ds.bs.wide) = c("non-data sci"," data sci")
summary.ds.bs.wide = mutate(summary.ds.bs.wide,Female.per = 
                                paste(sprintf('%0.1f',round(summary.ds.bs$percent[1:2]*100,digits = 1)),"%",sep = ""))
summary.ds.ms.wide = data.frame(acast(summary.ds.ms,datasci~sex,value.var = "number"))
rownames(summary.ds.ms.wide) = c("non-data sci"," data sci")
summary.ds.ms.wide = mutate(summary.ds.ms.wide,Female.per = 
                                paste(sprintf('%0.1f',round(summary.ds.ms$percent[1:2]*100,digits = 1)),"%",sep = ""))
summary.ds.phd.wide = data.frame(acast(summary.ds.phd,datasci~sex,value.var = "number"))
rownames(summary.ds.phd.wide) = c("non-data sci"," data sci")
summary.ds.phd.wide = mutate(summary.ds.phd.wide,Female.per = 
                                paste(sprintf('%0.1f',round(summary.ds.phd$percent[1:2]*100,digits = 1)),"%",sep = ""))

# summary table
kbl(summary.ds.bs.wide, caption = "Summary Statistics for BS Degrees Granted in SCI Field by Sex", digits = 2, booktabs = T,align = "lccc") %>%
  kable_styling(latex_options = c("HOLD_position"))%>%
   footnote(general = "The table reports the summary statistics for the amount of BS sci degrees granted over the sample period, separated by sex and data science or not.",
            threeparttable = T)
kbl(summary.ds.ms.wide, caption = "Summary Statistics for MS Degrees Granted in SCI Field by Sex", digits = 2, booktabs = T,align = "lccc") %>%
  kable_styling(latex_options = c("HOLD_position"))%>%
   footnote(general = "The table reports the summary statistics for the amount of MS sci degrees granted over the sample period, separated by sex and data science or not.",
            threeparttable = T)
kbl(summary.ds.phd.wide, caption = "Summary Statistics for PhD Degrees Granted in SCI Field by Sex", digits = 2, booktabs = T,align = "lccc") %>%
  kable_styling(latex_options = c("HOLD_position"))%>%
   footnote(general = "The table reports the summary statistics for the amount of PhD sci degrees granted over the sample period, separated by sex and data science or not.",
            threeparttable = T)

# barplot
ggplot(summary.ds.bs,aes(x=datasci,weight=number,fill=sex))+
  geom_bar(color = "black", width = .7,position = 'dodge')+
  theme_classic()+
  ylab('Number')+
  xlab('data science')+
  scale_fill_brewer(palette = "Set1")+
  labs(title = "The Barplot of BS Degrees Granted in SCI Field, by Sex")
ggplot(summary.ds.ms,aes(x=datasci,weight=number,fill=sex))+
  geom_bar(color = "black", width = .7,position = 'dodge')+
  theme_classic()+
  ylab('Number')+
  xlab('data science')+
  scale_fill_brewer(palette = "Set1")+
  labs(title = "The Barplot of MS Degrees Granted in SCI Field, by Sex")
ggplot(summary.ds.phd,aes(x=datasci,weight=number,fill=sex))+
  geom_bar(color = "black", width = .7,position = 'dodge')+
  theme_classic()+
  ylab('Number')+
  xlab('data science')+
  scale_fill_brewer(palette = "Set1")+
  labs(title = "The Barplot of PhD Degrees Granted in SCI Field, by Sex")
```
## Final Report

From the above analysis, we have a preliminary conclusion that females are underrepresented in SCI fields relative to non-SCI fields, which is consistent over time. It is more of this case in data science field and higher level of education. 

However, this conclusion is drawn in a relative sense; it does not tell us about fairness because of lack in a prior benchmark. If we believe that a "fair" division should be half to half, we have the conclusion that males are underrepresented in non-SCI fields, and the distribution is quite fair in the whole SCI field. Therefore, we should take the conclusion in this analysis more cautiously.

One concern about the data set is that it only measures the number of degrees granted in every field. The final goal is to measure the degree females are undderrepresented in science, and the number of degrees granted is only one indicator. The performance in school is left unmeasured, and the situation beyond schooling period is also untouched.

To tailor this analysis more, we can try to incorporate the enrollment data in every field. It can measure the performance in school to some degree, combined with the degree data. We can also collect the gender data in faculty or top researchers in every field. We can get a better understanding of the situation for females in science with these additional information.

# Case Study 3: Major League Baseball

This section aims to explore how payroll affects performance among Major League Baseball teams. The data is prepared in two formats record payroll, winning numbers/percentage by team from 1998 to 2014.

## EDA: Relationship between payroll changes and performance
```{r}
rm(list = ls())
paydata.wide = fread("data/MLPayData_Total.csv", encoding = "UTF-8")
setnames(paydata.wide,"Team.name.2014","team")

paydata.long = fread("data/baseball.csv", encoding = "UTF-8")
```

```{r, eval=FALSE}
# test conversion
# paydata.wide[,.(p1998:p2014)] # do not try to use .() and : simultaneously. otherwise return a vector step by +1

# pay = paydata.wide[,team,p1998:p2014] %>%
#   pivot_longer(cols = p1998:p2014,
#                names_prefix = "p",
#                names_to = "year",
#                values_to = "payroll")
# win.num = paydata.wide[,team,X1998:X2014] %>%
#   pivot_longer(cols = X1998:X2014,
#                names_prefix = "X",
#                names_to = "year",
#                values_to = "win.num")
# win.per = paydata.wide[,team,X1998.pct:X2014.pct] %>%
#   pivot_longer(cols = X1998.pct:X2014.pct,
#                names_prefix = "X",
#                names_to = "year",
#                values_to = "win.pct") %>%
#   mutate(year = substr(year,1,4))
# test.long = pay %>%
#   right_join(win.num, by = c("year","team")) %>%
#   right_join(win.per, by = c("year","team"))
```

The log difference is more appropriate in this setup because it measures the proportional (relative) change in the payroll. The base payrolls in all teams are not the same, so a same increase in absolute amount may incentivize players differently in different teams; the incentive may be bigger in teams with a smaller payroll, but smaller in teams with a larger payroll. The relative changes measured by the difference of logarithm of payroll can alleviate this problem. 

Therefore, we create the log difference in payroll, and a long data table including team, year, diff_log, win_pc.

```{r}
# create increments
paydata.long[order(team,year),log.pay := log(payroll)]
paydata.long[,pay.diff := c(NA,diff(payroll)),by = team]
paydata.long[,log.pay.diff := c(NA,diff(log.pay)),by = team]
paydata.new = paydata.long[,.(team,year,diff_log=log.pay.diff,win_pct)]
```

## Exploratory Questions
```{r}
increase.data = paydata.long[year %in% 2010:2014,.(
  log.pay.increase = log.pay[length(log.pay)]-log.pay[1], # from 2010 to 2014, increase in log(payroll)
  pay.increase = payroll[length(payroll)]-payroll[1],
  win.pct.increase = win_pct[length(win_pct)]-win_pct[1]
), by = team]
```

**Top 5 increase in log(payroll)**
```{r}
increase.data %>%
  filter(rank(-log.pay.increase)<6) %>%
  select(team) # top 5 teams in log(payroll) increase
```

The teams presented above are the top five teams experiencing the largest increase in log(payroll) in 2010-2014.

**Top 5 increase in payroll**
```{r}
increase.data %>%
  filter(rank(-pay.increase)<6) %>%
  select(team) # top 5 teams in payroll increase
```

The teams presented above are the top five teams experiencing the largest increase in payroll, i.e., the absolute value of payroll in 2010-2014. Four out of five have appeared in the top 5 lists in log(payroll) increase.

**Top 5 increase in winning percentage**
```{r}
increase.data %>%
  filter(rank(-win.pct.increase)<6) %>%
  select(team) # top 5 teams in winning percentage increase
```

The teams presented above are the top five teams experiencing the largest increase in winning percentage in 2010-2014.

## Prediction
Overall, the evidence supporting that the higher increases in payroll on the log scale lead to increased
performance is not clear.

```{r}
# 2010-2014
ggplot(increase.data,aes(x=pay.increase,y=win.pct.increase))+
  geom_point(color="blue",size=1.5)+
  geom_smooth(method = "lm",formula = y~x, color="red")+
  geom_text_repel(aes(label = team))+
  xlab("increase in payroll, 2010-2014")+
  ylab("increase in winning percentage, 2010-2014")+
  theme_bw()+
  labs("Relationship between Payroll Increase and Performance Increase, 2010-2014")
```

In 2010-2014, the increase in winning percentage seems to be positively correlated with the increase in payroll. However, it is not statistically significant because y=0 is within the error bound.

```{r}
# all years, year-on-year basis
paydata.long[,diff_win_pct := c(NA,diff(win_pct)), by = team]

ggplot(paydata.long,aes(x=log.pay.diff,y=diff_win_pct))+
  geom_point(color="blue",size=1.5)+
  geom_smooth(method = "lm", formula = y~x, color="red")+
  xlab("increase in payroll, year on year")+
  ylab("increase in winning percentage, year on year")+
  theme_bw()+
  labs("Relationship between Payroll Increase and Performance Increase, All Years")
```

**Regression, diff_win_pct~diff_log_pay, current period**
```{r}
summary(lm(diff_win_pct~log.pay.diff,data = paydata.long)) # not significant
```

Then we use the data in all years to figure out the correlation between increase in winning percentage and increase in payroll. Both the qualitative result from the scatter plot and the quantitative result from the regression are consistent with the conclusion above, that is, the positive predictive power for increase in payroll to increase in winning percentage is weak and not significant.

```{r}
# how about next year?
paydata.long[,diff_win_pct_next := c(diff(win_pct),NA), by = team]

ggplot(paydata.long,aes(x=log.pay.diff,y=diff_win_pct_next))+
  geom_point(color="blue",size=1.5)+
  geom_smooth(method = "lm", formula = y~x, color="red")+
  xlab("increase in payroll, year on year")+
  ylab("increase in winning percentage next year, year on year")+
  theme_bw()+
  labs("Relationship between Payroll Increase and Performance Increase Next Year, All Years")
```

**Regression, diff_win_pct~diff_log_pay, lag 1**
```{r}
summary(lm(diff_win_pct_next~log.pay.diff,data = paydata.long)) # negative and not significant
```

If the underlying driven force for the positive correlation between payroll increase and winning percentage increase is the introduction of better players,the correlation is most plausibly expected in the current period. However, according to the efficient wage theory, one may argue that the increase in payroll is to incentivize the current players; if they do not work harder, they may lose their well-paid positions. The positive correlation may lie between payroll increase and lagged winning percentage in this case, since it takes time for players to respond to the incentives. We test this hypothesis with a lag of one year. The result does not approve of this hypothesis, either. 

## Comparison
We test the predictive power of three alternatives in addition: payroll to winning percentage (a replication of the one we've seen in class), payroll to increase in winning percentage next year, and payroll to increase in winning percentage current year. 

**payroll to winning percentage**

```{r}
ggplot(paydata.long,aes(x=log.pay,y=win_pct))+
  geom_point(color="blue",size=1.5)+
  geom_smooth(method = "lm", formula = y~x, color="red")+
  xlab("log payroll")+
  ylab("winning percentage")+
  theme_bw()+
  labs("Relationship between Payroll and Performance, All Years")
summary(lm(win_pct~log.pay,data = paydata.long)) # good prediction
```


**payroll to increase in winning percentage, next year**
```{r}
ggplot(paydata.long,aes(x=log.pay,y=diff_win_pct_next))+
  geom_point(color="blue",size=1.5)+
  geom_smooth(method = "lm", formula = y~x, color="red")+
  xlab("log payroll")+
  ylab("increase in winning percentage next year, year on year")+
  theme_bw()+
  labs("Relationship between Payroll and Performance Increase Next Year, All Years")
summary(lm(diff_win_pct_next~log.pay,data = paydata.long)) # not bad prediction? can be spurred
```

**pay roll to increase in winning percentage, current year**
```{r}
ggplot(paydata.long,aes(x=log.pay,y=diff_win_pct))+
  geom_point(color="blue",size=1.5)+
  geom_smooth(method = "lm", formula = y~x, color="red")+
  xlab("log payroll")+
  ylab("increase in winning percentage, year on year")+
  theme_bw()+
  labs("Relationship between Payroll and Performance Increase Next Year, All Years")
summary(lm(diff_win_pct~log.pay,data = paydata.long)) # not bad prediction? can be spurred

# The last two prediction power should be taken cautiously. It may stem from some rising small teams
```

Overall, current payroll predicts current performance well. As for changes in performance, there is weak evidence that increase in current performance is positively correlated to increase in payroll, but still not very predictive. It is surprising that the increase in performance, no matter current or future, is negatively correlated with the current payroll, to some degree. However, we should be cautious about this conclusion as it may be mainly driven by some rising small teams. 

One more thing to note is that correlation does not mean causality. Even if our finding is that the increase in payroll is significantly positively correlated to the increase in winning percentage, we cannot say that it is causality. Just like what we point out in the last section, the introduction of better players or coaches is possibly their common parent. 

```{r}
save.image("hw1.RData")
```